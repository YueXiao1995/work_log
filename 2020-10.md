# Work Log of  October

---

## Week 1

---

### 10-09

* 计划
  * [x] 查找审核统计邮件国庆期间发送失败原因，并修复bug
  * [x] 准备对新的模型进行压力测试
  * [ ] 编写测试用例集
  * [ ] 统计高、低风险文本的判断准确，召回等指标，并加入统计邮件
* 完成
  * 查找审核统计邮件国庆期间发送失败原因，并修复bug
    * 失败原因是审核部门设置先审后发导致日志中出现了没有见过的参数
    * 以后遇到这种情况发统计数据默认为零的邮件
  * 调试bert服务，配置环境。
    * 修改代码使审核主服务（测试）访问LVS
    * 配置新环境，安装gunicorn，gevent，flask等
* 收获
  
  * 拷贝conda环境
  
    ```bash
    conda create -n new_env --clone target_env # 只能克隆通过 conda install 命令安装的包，通过pip等方式安装的包并不会被克隆
    ```
  
    

---

### 10-10

* 计划

  * [x] 修改长字符串的切割方式
  * [ ] 编写测试用例
  * [x] 对新项目进行压力测试
  * [ ] 统计高、低风险文本的判断准确，召回等指标 并加入统计邮件

* 完成

  * 修改长字符串的切割方式
  * 使用过往日志数据，对新项目进行压力测试

* 收获

  * bash中并发执行python脚本。 

    ``` bash
    #!/bin/bash
    # 使用 & 并发地执行script.py， 末尾注意加上 wait
    python3 script.py &
    python3 script.py &
    python3 script.py &
    wait
    ```

---

### Summary

* 本周完成
* 下周计划

---

## Week 2

---

### 10-12

* 计划
  * [x] 编写测试用例，测试新审核服务功能正常
  * [x] 在33/32上各自再多部署4个端口，对新项目进行压力测试
  * [ ] 对高、低风险文本的召回，准确等进行统计并加入统计邮件，将被判为低风险但实际违规的文本以附件形式加入例行邮件
  
* 完成

  * 编写测试用例，用于进行功能测试，可以一次性测试所有服务的各项功能（接口返回数据是否正确）
  * 在32/33机器上部署多个服务，各自分别监听一个端口，进行压力测试
    * 系统处理并发请求的能力很差，经过分析，发现并不是新的bert服务导致的，而是原有的一个外部依赖没有能力处理这么多的并发请求，证明新功能不会影想整个系统的并发能力，它不是瓶颈。
  * 参加报销培训，学习使用新的报销系统
  * 收到紧急任务，要求找到过去所有包含落马官员名字的UGC内容（发帖、评论）极其id
    * 在日志中查找，产出主版本高风险帖子及评论的id

* 收获

  * 文件的压缩与解压

    ``` bash
    # 压缩
    tar -zcvf folder.tar.gz folder 
    # 解压
    tar -zxvf python.tar.gz
    ```

---

### 10-13

* 计划
  * [x] 完成紧急任务，产出k12高风险消息及id
  * [x] 完善新的审核服务的维护工具
    * 启动，停止，重启，部署等
  * [x] 在33的8091到8095端口部署新服务
  * [ ] 用一天的数据过一遍模型，对高、低风险文本的召回，准确等进行统计并加入统计邮件，将被判为低风险但实际违规的文本以附件形式加入例行邮件
* 完成
  * 产出k12高风险消息及id
  * 熟悉报销相关流程，报销团建费用
  * 在33机器上另外部署5个端口
  * 修改代码，以supervise方式重新部署项目，并进行测试
* 收获
  * 无

---

### 10-14

* 计划

  * [x] 上线新服务
  * [x] 修改审核逻辑
    * [x] 用户名不过bert二分类检测
  * [ ] 对高、低风险文本的召回，准确等进行统计并加入统计邮件，将被判为低风险但实际违规的文本以附件形式加入例行邮件

* 完成

  * 上线新服务
  * 修改审核逻辑 ，用户名不过bert二分类检测

* 收获

  * 查找 gunicorn 主进程

    ``` bash
    pstree -ap|grep gunicorn
    ```

  * 动态显示日志末尾数据

    ```bash
    tail -f main.log
    ```

---

### 10-15

* 计划、
  * [x] 修改审核统计邮件
    * [x] 修改邮件主题
    * [x] 修改收件人列表
    * [x] 增加附件 invalid_samples.txt
  * [x] 修改UGC审核主服务，部署测试上线
    * [x] 修正日志格式
    * [x] 修正bert_check传参
    * [x] 解决 带图片链接的文本 导致的问题
  * [ ] 对高、低风险文本的召回，准确等进行统计并加入统计邮件，将被判为低风险但实际违规的文本以附件形式加入例行邮件
    * [x] 从33/32机器的审核日志中获取msgId及其对应的违规分数，并传送到41机器的统计项目的data目录下，设为定时任务
    * [ ] 对高、低风险文本的召回，准确等进行统计并加入统计邮件，将被判为低风险但实际违规的文本以附件形式加入例行邮件
  
* 完成

  * 修改审核统计邮件，修改主题，变更收件人，增加违规样本附件
  * 修改UGC审核主服务，解决了一些bug，日志中加入topicId记录，测试部署上线
  * 从33/32机器的审核日志中获取msgId及其对应的违规分数，并传送到41机器的统计项目的data目录下，设为定时任务

* 收获

  * linux 跨机器文件传输

    ```bash
    # 从本地传输到远端
    scp -P 33312 ./target_file SanJunipero@10.100.100.41:/saving_path
    ```

---

### 10-16

* 计划
  * [ ] 对高、低风险文本的召回，准确等进行统计并加入统计邮件，将被判为低风险但实际违规的文本以附件形式加入例行邮件
* 完成
  * 规范包含违规分数的日志
  * 对高、低风险文本的召回，准确等进行统计（20%）
  * 发送周报
* 收获
  * 无

---

### 10-18

* 计划
  * [x] 对高、低风险文本的召回，准确等进行统计并加入统计邮件，将被判为低风险但实际违规的文本以附件形式加入例行邮件
* 完成
  * 对高、低风险文本的召回，准确，误判量等进行统计并加入统计邮件，将被判为低风险但实际违规的文本以附件形式加入例行邮件
    * 遇到了邮件无法正常发送的问题
* 收获
  * 无

---

### Summary

* 本周完成

  * 编写测试用例，用于对所有服务接口进行接口测试，验证接口是否工作正常。
  * 在32/33机器部署共计12个服务，监听不同端口，进行压力测试
    * 进行压力测试时，发现审核系统处理并发请求的能力很差，经过分析，发现并不是新添加的bert检查导致的，而是原有的一个外部依赖没有能力处理这么多的并发请求，证明新功能不会影想整个系统的并发能力，不是瓶颈。
  * 使用supervise重新部署新的审核服务，在修改nginx配置并reload后，正式上线新的带有bert模型检测的新服务，替换掉原有的服务。新服务增加一个入参，增加一个出参。
  * 修改审核逻辑使用户名检查不过bert二分类服务，修复了一些日志格式，文本预处理方面的bug。
  * 对高、低风险文本的召回，准确等进行统计并加入统计邮件，将被判为低风险但实际违规的文本以附件形式加入例行邮件（进行中，完成约50%）

  * 维护修改审核统计邮件，并增加一个包含所有违规样本的附件
  * 从过往3年日志中找出包含一批黑名单人名的全部文本及其id

* 下周计划

  * 完善对于高低风险文本的各项相关统计
  *  修改bert代理服务的日志记录
  * 跟踪观测bert算出的违规分数，及漏召回的违规样本
  
  

---

## Week 3

---

### 10-19

* 计划
  * [x] 解决例行统计邮件无法发送的问题
  * [x] 调整统计邮件内容
* 完成
  * 解决例行统计邮件无法发送的bug，发现原因是调用api时端口号写错了
  * 调整统计邮件显示内容
* 收获
  * **代理**
    * 正向代理：隐藏真实的请求端
    * 反向代理：隐藏真实的服务端
  * **集群与分布式**
    * 单机：一个项目，部署在在一台服务器上
    * 集群：单机复制几份， 构成“集群”。 每台服务器都成为了集群的一个“节点”。 易于扩展，提高系统的处理能力。
    * 分布式：按照业务功能。将一个系统拆分成多个独立的子系统，部署在不同的服务器上。如果服务之间有依赖关系，则通过RPC（Remote Procedure Call）方式调用。降低系统之间的耦合度， 更易于扩展，服务的复用性高。

---

### 10-20

* 计划
  * [x] 查找在删除日志里部分机审违规文本被标注为人审的原因
  * [ ] 对k12的高低风险文本进行统计
* 完成
  * 查找在删除日志里部分机审违规文本被标注为人审的原因
    * 因为用户等级高，所以可以免审，机审结果未被使用
  * 与审核部门沟通讲解统计邮件中新增加的表的具体含义
  * 获取k12的cs分数，对k12的高低风险文本进行统计 （30%）
    * 编写了将k12日志单独分离的代码，但由于环境问题无法运行
* 收获
  * 无

---

### 10-21

* 计划
  * [x] 修复统计邮件中数据错误的问题
  * [x] 对k12的高低风险文本进行统计
* 完成
  * 修复统计邮件中的数据错误问题，将k12 和 非 k12的数据分开保存
  * 对k12的高低风险文本的召回率等指标进行统计，产出统计结果，并加入例行邮件
* 收获
  * 无

---

### 10-22

* 计划
  * [x] 处理例行统计邮件bug
  * [ ] 重构k12统计项目，产出k12的全部样本，可以例行产出新样本
  * [ ] 修改bert代理服务的日志记录
* 完成
  * 修复导致邮件发送失败的bug
  * 重构k12统计项目
* 收获

---

### 10-23

* 计划

  * [ ] 重构每日例行的统计与样本生成项目
  * [ ] 生成k12的全部样本，例行产出新样本

* 完成

  * 重构每日例行的统计与样本生成项目，将ugc主板本和k12的相关代码放在同一个目录下
  * 根目录被误删，恢复软链，环境

* 收获

  * 建立软链接

    ```bash
    # ln -s 源目录 目标目录
    ln -s /hadoop/01/rd/xiaoyue xiaoyue
    ```

---

### 10-25

* 计划
  * [x] 统计项目重构
  * [x] k12正负样本产出
* 完成
  * 重构机器审核统计项目，降低维护成本
  * 产出自2020-07-29以来的全部k12样本
  * 修复由于周五环境被误删而导致的plot图片无法生成的问题
* 收获
  * 无

----

### Summary

* 本周完成
  * 整合UGC审核打点日志，与机审服务本地的审核日志，根据bert模型计算出的cs分数（高、低风险）对顺利通过机器审核（旧版本）的文本进行分类，并计算召回率、准确率等指标，加入例行统计邮件。将被判为低风险但实际违规的文本以附件形式加入例行邮件。
  * 重构k12统计项目，便于统计和生成正负样本。
  * 整合k12打点日志，与机审服务本地的审核日志，根据bert模型计算出的cs分数（高、低风险）对顺利通过机器审核（旧版本）的文本进行分类，并计算召回率、准确率等指标，加入例行统计邮件。将被判为低风险但实际违规的文本以附件形式加入例行邮件。（经讨论暂时从例行统计邮件中撤下这两项）
  * 从日志中产出自2020-07-29以来所有的k12的样本，并生成统计结果
* 下周计划
  * 整理当前bert模型的所有数据集，及样本生成、模型训练、结果评估的相关代码。
  * 从日志中产出全部k12样本，结合之前已有的k12样本，训练一个针对k12审核的bert模型

---

## Week 4

---

### 10-26

* 计划
* 完成
* 收获

---

### 10-27

* 计划
* 完成
* 收获

---

### 10-28

* 计划
* 完成
* 收获

---

### 10-29

* 计划
* 完成
* 收获

---

### 10-30

* 计划
* 完成
* 收获

---

### Summary

* 本周完成
* 下周计划

---

## Summary of October

* 本月完成
* 下月计划